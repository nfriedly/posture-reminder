<!DOCTYPE html>
<html>
<head>
<title>Posture Reminder</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.1.1/superhero/bootstrap.min.css"/>
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"/>
<style type="text/css">
.splash {
    background: linear-gradient(20deg, #080F1F 30%, #2B4B5A 87%, #435E67 100%) repeat fixed 0 0 rgba(0, 0, 0, 0);
    color: #FFFFFF;
    padding: 4em 0 2em;
    text-align: center;
}
.form-inline input[type=number].form-control {
    display: inline; /* for smaller screens - override Bootstrap's default display: block*/
    width: 33px;
    border:0;
    border-bottom: 1px solid white;
    padding: 0;
    margin: 0 3px 3px 5px;
    background:inherit;
    color: inherit;
    -moz-box-shadow: 0 0 0 black;
    -webkit-box-shadow: 0 0 0 black;
    box-shadow: 0 0 0 black;
    height: 20px;
    line-height: 1;
    text-align: right;
}
.banner {
    display: inline-block;
}
.banner i.fa {
    font-size: 1.5em;
    top: 10px;
    position: relative;
}
</style>
</head>
<body>
<div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="/" class="navbar-brand"><i class="fa fa-male"></i> Posture Reminder</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav">
            <li>
              <a href="http://nfriedly.com/" title="Javascript and Node.js expert">by Nathan Friedly</a>
            </li>
            <li>
              <a href="https://github.com/nfriedly/posture-reminder"><i class="fa fa-github"></i> Source</a>
            </li>
        </div>
      </div>
    </div>

      <header class="jumbotron splash">
         <div class="container">
            <div class="banner">
                <h1><i class="fa fa-male pull-left"></i>  Posture Reminder</h1>
                <p class="lead">Keeping your back on the straight and narrow.</p>
            </div>
        </div>
      </header>
      <main>
        <div class="container">
        <form class="form-inline">
            <fieldset>
              <legend><i class="fa fa-clock-o"></i> Reminder</legend>
              Ask about your posture next in
              <input type="number" id="hours" name="hours" class="form-control" value="0" placeholder="h">
              hours
              <input type="number" id="minutes" name="minutes" class="form-control" value="1" placeholder="m">
              minutes
              <input type="number" id="seconds" name="seconds" class="form-control" value="0" placeholder="s">
              seconds:  &nbsp;
              <button class="btn btn-primary" id="go" type="button">Go</button>
            </fieldset>
            <label><input type="checkbox" id="play-sounds" name="play-sounds" checked="checked"> Play Sounds (requires browser support)</label>
        </form>
        <br />
        <form class="form-horizontal">
            <fieldset>
              <legend><a href="#advanced-settings" data-toggle="collapse" data-target="#advanced-settings"><i class="fa fa-cogs"></i> Advanced Settings</a></legend>
              <div class="collapse" id="advanced-settings">
                  <div class="form-group">
                    <label class="col-lg-2 control-label" for="success">Success Multiplier</label>
                    <div class="col-lg-10">
                      <input type="text" id="success" name="success" class="form-control" value="1.6">
                      <span class="help-block">Should be &gt; 1</span>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-lg-2 control-label" for="failure">Failure Multiplier</label>
                    <div class="col-lg-10">
                      <input type="text" id="failure" name="failure" class="form-control" value="0.5">
                      <span class="help-block">Should be &lt; 1</span>
                    </div>
                  </div>
              </div>
            </fieldset>
          </form>
          </div>
      </main>
    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script>
        var afterDomUpdate = (typeof setImmediate == "undefined") ? setTimeout : setImmediate;
        var interval,
            $hours = $('#hours'),
            $minutes = $('#minutes'),
            $seconds = $('#seconds'),
            $success = $('#success'),
            $failure = $('#failure'),
            $go = $('#go'),
            $playSounds = $('#play-sounds'),
            intervalLength,
            intervalRemaining;

        // disable the play-sounds checkbox if the browser doesn't suport it
        if (!window.AudioContext) {
            $playSounds.click().disable().parent().addClass('disabled text-muted');
        }

        // returns the current delay in seconds
        function getTime() {
            var hours = parseInt($hours.val(), 10) || 0,
                minutes = parseInt($minutes.val(), 10) || 0,
                seconds = parseInt($seconds.val(), 10) || 0,
                totalSeconds = seconds + (minutes * 60) + (hours * 3660);
            return totalSeconds > 0 ? totalSeconds : 60;
        }
        // splits seconds up into hours minutes and seconds
        function setTime(totalSeconds) {
            if (totalSeconds < 0) {
                totalSeconds = 0;
            }
            var hours = Math.floor(totalSeconds/3600),
                minutes = Math.floor( (totalSeconds%3600)/60 ),
                seconds = Math.round( totalSeconds%60);
            $hours.val(hours);
            $minutes.val(minutes);
            $seconds.val(seconds);
        }

        function showAlert() {
            var isPostureGood = confirm("How's your posture?\n\n - Good posture: click [OK]\n - Bad posture: click [Cancel]");
            var multiplier = parseFloat(isPostureGood ? $success.val() : $failure.val()) || (isPostureGood ? 1.6 : 0.5);
            // round up for good posture, round down for bad - this way we should avoid getting stuck on the same value.
            intervalLength = Math[isPostureGood ? "ceil" : "floor"](intervalLength * multiplier);
            $go.click();
        }
        
        function ask() {
            stop();
            if ($playSounds.is(':checked')) {
                beepBoop().then(showAlert);
            } else {
                showAlert();
            }
        }
        function update() {
            intervalRemaining--;
            setTime(intervalRemaining);
            if (intervalRemaining < 1) {
                clearInterval(interval);
                // give the browser a chance to update the DOM before creating the alert (we want it to show 0 seconds remaining, not 1);
                afterDomUpdate(function(){
                    ask();
                    setup();
                });
            }
        }
        function setup() {
            intervalRemaining = intervalLength;
            setTime(intervalLength);
            if (intervalRemaining > 0) { // otherwise our first update call killed it
                interval = setInterval(update, 1000);
            }
        }
        function stop() {
            clearInterval(interval);
            setTime(intervalLength);
            quiet()
        }
        $go.click(function() {
            var isRunning = $go.hasClass('btn-danger');
            if (isRunning) {
                $go.addClass('btn-primary').removeClass('btn-danger').text('Go');
                quiet();
            }
            else {
                $go.addClass('btn-danger').removeClass('btn-primary').text('Stop');
                intervalLength = getTime();
                setup();
            }
        });

        function beepBoop() {
            return playNote(540)
                    .then(wait(250))
                    .then(note(300))
                    .then(wait(250))
                    .then(quiet);
        }

        // note playNote returns a promise, but the rest return functions that then return a promise
        // this allows the action to take place later, rather than as we're creating the promise chain

        var ctx, boost, osc;
        function playNote(freq) {
            return new Promise(function(resolve, reject) {
                if (!window.AudioContext) {
                    return reject();
                }
                ctx = ctx || new AudioContext();
                boost = boost || ctx.createGain();
                boost.gain.value = 1;
                if (!osc) {
                    osc = ctx.createOscillator();
                    osc.connect(boost);
                    boost.connect(ctx.destination);
                    osc.start(0);
                }
                osc.frequency.value = freq;
                resolve();
            });
        }

        function wait(ms) {
            return function() {
                return new Promise(function(resolve){
                    setTimeout(function() {
                        resolve();
                    }, ms);
                });
            };
        }

        function note(freq, length) {
            return playNote.bind(null, freq, length);
        }

        function quiet(){
            return new Promise(function(resolve){
                boost.gain.value = 0;
                setTimeout(resolve, 100);
            });
        }
        
    </script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
</body>
</html>
